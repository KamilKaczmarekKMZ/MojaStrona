/* css/stack-element.css */
/* Usuwamy @use postcss-preset-env - to jest dla PostCSS, nie dla przeglądarki */

.new-stack-section .stack {
  display: grid;
  grid: [stack] / [stack];
  perspective: 5000px; /* Dodano 'px' */
  position: sticky;
  top: 50vh;
  transform: translateY(-50%);
  margin: 20vh 0;
  z-index: 1; /* Ważne: musi być wyżej niż tło, ale niżej niż model 3D? */
  
  /* Usunięto pseudoelement :before który tworzył tło - kolidowałby z Twoim głównym tłem */
}
/* Nowa reguła dla pseudoelementu - wewnątrz naszej sekcji */
.new-stack-section::before {
    content: "";
    position: fixed;
    inset: 0;
    background: color-mix(in lch, color(display-p3 0.95 0.95 0.95) calc(100% - var(--scroll-progress, 0%)), color(display-p3 0.15 0.15 0.15) var(--scroll-progress, 0%));
    pointer-events: none;
    z-index: -1; /* Za tłem hexagonów, ale przed gradientem body */
}

.new-stack-section .card {
  grid-area: stack;
  
  --z-offset: 0;
  --easeInOutCirc: cubic-bezier(0.85, 0, 0.15, 1);
  --bg-opacity: 0%;
  --scroll-progress: 0%;
  
  /* Płynne transformacje bazujące na scrollu */
  transform: 
    rotateX(calc(45deg * var(--scroll-progress))) 
    rotate(calc(45deg * var(--scroll-progress))) 
    translateZ(calc(var(--z-offset) * var(--scroll-progress))) 
    translateY(calc(20vh * var(--scroll-progress))) 
    translateX(calc(20vh * var(--scroll-progress)));
  
  transition: none; /* Usuwamy transition dla płynności scrolla */
  
  inline-size: 40vmin;
  block-size: 40vmin;
  box-sizing: border-box;
  color: white;
  background: color(display-p3 1 1 1 / 0.05); /* Zamieniono lch na display-p3 dla wsparcia */
  position: relative;
  
  @media (orientation: landscape) {
    inline-size: 40vh;
    block-size: 40vh;
  }
  
  @media (max-width: 540px) {
    inline-size: 60vw;
    block-size: 60vw;
  }
  
  /* Zachowane oryginalne offset-y Z */
  &:nth-child(1) {
    z-index: 3;
    --z-offset: 75vh;
  }
  
  &:nth-child(2) {
    z-index: 2;
    --z-offset: 50vh;
  }
  
  &:nth-child(3) {
    --z-offset: 25vh;
  }
  
  &:nth-child(4) {
    --z-offset: 0vh;
  }
  
  &:nth-child(5) {
    --z-offset: -25vh;
  }
  
  &::after {
    content: "Box";
    position: absolute;
    left: -45%;
    top: 110%;
    font-size: 1.25rem;
    text-shadow: 0 1px 3px color(display-p3 0 0 0 / 0.75); /* display-p3 zamiast lch */
    white-space: nowrap;
    padding: 1ch 2ch;
    border-radius: 4ch;
    opacity: var(--scroll-progress);
    transform: 
      rotate(calc(-45deg * var(--scroll-progress))) 
      rotateY(calc(45deg * var(--scroll-progress))) 
      translateX(calc(20px * (1 - var(--scroll-progress))));
    background: color(display-p3 0 0 0 / calc(0.7 * var(--scroll-progress))); /* display-p3 zamiast lch */
    
    @media (max-width: 540px) {
      left: -20%;
      top: 70%;
    }
  }
  
  /* Użyj podwójnej klasy dla specyficzności .card.content */
  &.content {
    z-index: 5;
    padding: 5vmin;
    font-size: max(2.5vmin, .9rem);
    line-height: 1.5;
    background: color-mix(in srgb, white calc(100% - var(--scroll-progress)), transparent var(--scroll-progress)); /* srgb zamiast lch */
    border: 5px solid color-mix(in srgb, hotpink calc(100% - var(--scroll-progress)), transparent var(--scroll-progress)); /* srgb zamiast lch */
    color: color-mix(in srgb, black calc(100% - var(--scroll-progress)), white var(--scroll-progress)); /* srgb zamiast lch */
    
    &::after { 
      content: "Find area to automate"; 
      left: -50%;
      
      @media (max-width: 540px) {
        left: -23%;
      }
    }
  }
  
  &.padding {
    background: transparent;
    z-index: 4;
    
    &::after { content: "Formalise"; }
    &::before {
      content: "";
      position: absolute;
      inset: 0;
      clip-path: polygon(
        0% 0%, 0% 100%, 
        5vmin 100%, 5vmin 5vmin, 
        calc(100% - 5vmin) 5vmin, 
        calc(100% - 5vmin) calc(100% - 5vmin), 
        5vmin calc(100% - 5vmin), 5vmin 100%, 
        100% 100%, 100% 0%
      );
      background: repeating-linear-gradient(
        -45deg, 
        cyan, cyan 1px, 
        color(display-p3 1 1 1 / 0.05) 1px, color(display-p3 1 1 1 / 0.05) 10px /* display-p3 */
      );
      opacity: var(--scroll-progress);
    }
  }
  
  &.border {
    z-index: 3;
    background: transparent;
    
    &::after { content: "Build"; }
    &::before {
      content: "";
      position: absolute;
      inset: 0;
      clip-path: polygon(
        0% 0%, 0% 100%, 
        5px 100%, 5px 5px, 
        calc(100% - 5px) 5px, 
        calc(100% - 5px) calc(100% - 5px), 
        5px calc(100% - 5px), 5px 100%, 
        100% 100%, 100% 0%
      );
      background: linear-gradient(hotpink, hotpink);
      opacity: var(--scroll-progress);
    }
  }
  
  &.background {
    z-index: 2;
    /* POPRAWIONE: Białe tło które pojawia się podczas animacji */
    background: rgba(255, 255, 255, var(--scroll-progress));
    
    &::after { 
      content: "Test"; 
      left: -45%;
      
      @media (max-width: 540px) {
        left: -20%;
      }
    }
  }
  
  &.box-shadow {
    z-index: 1;
    background: transparent;
    
    box-shadow:
      0 2.8px 2.2px rgba(0, 0, 0, calc(0.02 * var(--scroll-progress))),
      0 6.7px 5.3px rgba(0, 0, 0, calc(0.028 * var(--scroll-progress))),
      0 12.5px 10px rgba(0, 0, 0, calc(0.035 * var(--scroll-progress))),
      0 22.3px 17.9px rgba(0, 0, 0, calc(0.042 * var(--scroll-progress))),
      0 41.8px 33.4px rgba(0, 0, 0, calc(0.05 * var(--scroll-progress))),
      0 100px 80px rgba(0, 0, 0, calc(0.07 * var(--scroll-progress)))
    ;

    &::after { content: "Implement"; }
  }
}

/* Usunięto całkowicie reguły dla body i p - są już zdefiniowane w głównym CSS */
/* .new-stack-section p:first-of-type { ... } - możesz dodać jeśli potrzebujesz, ale prawdopodobnie nie */

.new-stack-section #desktop-prompt,
.new-stack-section #mobile-prompt {
  display: inline !important;
}
